---

- name: Agregando puertos a firewall en master
  firewalld:
    port: "{{item}}"
    permanent: yes
    state: enabled
    immediate: yes
  loop:
    - 6443/tcp
    - 2379/tcp
    - 2380/tcp
    - 10250/tcp
    - 10251/tcp
    - 10252/tcp
    - 10255/tcp
 
- name: Reiniciar firewall
  command: firewall-cmd --reload
  
- name: Configurando kubeadm
  command: kubeadm config images pull #--cri-socket /var/run/crio/crio.sock

- name: Permitir acceso desde workers
  firewalld:
    permanent: yes
    immediate: yes
    state: enabled
    rich_rule: "{{ item }}"
  with_items: "{{ workers_rule }}"

- name: Reiniciar firewall
  command: firewall-cmd --reload

- name: Permitir acceso de contenedores a localhost
  firewalld:
    permanent: yes
    immediate: yes
    state: enabled
    rich_rule: "{{ kube_perm_workers_rule }}" 

- name: Verificar si kubeadm esta iniciado
  stat:
    path: /etc/kubernetes/pki/ca.key
  register: k8adm_ca

- name: Reiniciar firewall
  command: firewall-cmd --reload

- name: Inicializar el cluster en {{ pod_network_cidr }}
  shell: kubeadm init --pod-network-cidr {{ pod_network_cidr }} --ignore-preflight-errors=NumCPU --ignore-preflight-errors=Mem
  args:
     chdir: $HOME
     creates: cluster_initialized.txt
  when: not k8adm_ca.stat.exists
  run_once: yes

- name: Obtener token para ejecutar join en workers
  shell: kubeadm token create --print-join-command
  register: kubernetes_join_command
  become: yes

- name: Imprimir token
  debug:
     var: kubernetes_join_command.stdout

- name: Copiar token a un archivo local
  local_action: copy content="{{ kubernetes_join_command.stdout_lines[0] }}" dest="/tmp/kubernetes_join_command" mode=0777

- name: "Creando directorio .kube"
  command: 
    cmd: "mkdir -p $HOME/.kube"
    warn: no
  
- name: Copy file with owner and permissions
  copy:
    src: /etc/kubernetes/admin.conf
    dest: $HOME/.kube/config
    owner: root
    group: root
    mode: '0644'

- name: export KUBECONFIG
  shell: "export KUBECONFIG=/etc/kubernetes/admin.conf"

- name: "Cambiando propietario al directorio .kube"
  shell: 
     cmd: "chown $(id -u):$(id -g) $HOME/.kube/config"
     warn: no